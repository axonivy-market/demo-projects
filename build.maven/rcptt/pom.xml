<project xmlns="http://maven.apache.org/POM/4.0.0" 
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
  <modelVersion>4.0.0</modelVersion>
  <groupId>ch.ivyteam.demo</groupId>
  <artifactId>build-maven-rcptt</artifactId>
  <version>9.2.0-SNAPSHOT</version>
  <packaging>pom</packaging>

  <properties>
    <rcptt.version>2.5.1</rcptt.version>
    <designer.os.arch>Windows_x64</designer.os.arch>
  </properties>

  <pluginRepositories>
    <pluginRepository>
      <id>repo.eclipse.org.rcptt</id>
      <url>https://repo.eclipse.org/content/repositories/rcptt/</url>
      <snapshots>
        <updatePolicy>always</updatePolicy>
      </snapshots>
    </pluginRepository>
  </pluginRepositories>

  <profiles>
    <profile>
      <id>unix.path</id>
      <activation>
        <os>
          <family>unix</family>
        </os>
      </activation>
      <properties>
        <designer.os.arch>Linux_x64</designer.os.arch>
      </properties>
    </profile>
  </profiles>

  <build>
    <plugins>
      <plugin>
        <groupId>org.eclipse.rcptt</groupId>
        <artifactId>rcptt-maven-plugin</artifactId>
        <version>${rcptt.version}</version>
        <extensions>true</extensions>
        <configuration>
          <runner>
            <version>${rcptt.version}</version>
          </runner>
          <aut>
            <explicit>${aut.url}</explicit>
          </aut>
        </configuration>
        <executions>
          <execution>
            <id>default-package</id>
            <phase>never</phase>
            <!-- skip as it builds a huge ZIP including our AUT -->
          </execution>
        </executions>
      </plugin>
      <plugin>
        <artifactId>maven-antrun-plugin</artifactId>
        <version>1.8</version>
        <executions>
          <execution>
            <phase>initialize</phase>
            <goals>
              <goal>run</goal>
            </goals>
            <id>setup.designer.version.properties</id>
            <configuration>
              <exportAntProperties>true</exportAntProperties>
              <target>
                <property name="job.html" value="${project.build.directory}/lastSuccess.html"/>
                <get src="${build.last.sucess.url}" dest="${job.html}"/>
                <loadfile srcFile="${job.html}" property="designer.zip">
                  <filterchain>
                    <linecontainsregexp>
                      <regexp pattern="products/AxonIvyDesigner[^_]*_${designer.os.arch}\.zip"/>
                    </linecontainsregexp>
                    <striplinebreaks/>
                    <tokenfilter>
                      <replaceregex pattern="(.*)products/(AxonIvyDesigner[^_]*_${designer.os.arch}\.zip)(.*)" replace="\2"/>
                    </tokenfilter>
                  </filterchain>
                </loadfile>
                <property name="aut.url">${build.last.sucess.url}artifact/workspace/ch.ivyteam.ivy.designer.product/target/products/${designer.zip}</property>
                <echo>target AUT = '${aut.url}'</echo>
              </target>
            </configuration>
          </execution>
        </executions>
      </plugin>
    </plugins>

    <pluginManagement>
      <plugins>        
        <plugin>
          <groupId>org.eclipse.m2e</groupId>
          <artifactId>lifecycle-mapping</artifactId>
          <version>1.0.0</version>
          <configuration>
            <lifecycleMappingMetadata>
              <pluginExecutions>
                <pluginExecution>
                  <pluginExecutionFilter>
                    <groupId>org.apache.maven.plugins</groupId>
                    <artifactId>maven-antrun-plugin</artifactId>
                    <versionRange>1.8</versionRange>
                    <goals>
                      <goal>run</goal>
                    </goals>
                  </pluginExecutionFilter>
                  <action>
                    <ignore />
                  </action>
                </pluginExecution>
                <pluginExecution>
                  <pluginExecutionFilter>
                    <groupId>org.eclipse.rcptt</groupId>
                    <artifactId>rcptt-maven-plugin</artifactId>
                    <versionRange>[2.4.3,)</versionRange>
                    <goals>
                      <goal>execute</goal>
                      <goal>resources</goal>
                    </goals>
                  </pluginExecutionFilter>
                  <action>
                    <ignore></ignore>
                  </action>
                </pluginExecution>
              </pluginExecutions>
            </lifecycleMappingMetadata>
          </configuration>
        </plugin>
      </plugins>
    </pluginManagement>
  </build>
</project>
