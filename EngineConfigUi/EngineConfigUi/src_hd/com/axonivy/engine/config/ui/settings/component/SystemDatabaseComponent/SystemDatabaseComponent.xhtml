<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:f="http://xmlns.jcp.org/jsf/core"
	xmlns:h="http://xmlns.jcp.org/jsf/html"
	xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
	xmlns:ic="http://ivyteam.ch/jsf/component"
	xmlns:p="http://primefaces.org/ui"
	xmlns:pe="http://primefaces.org/ui/extensions"
	xmlns:pm="http://primefaces.org/mobile"
	xmlns:c="http://xmlns.jcp.org/jsp/jstl/core"
	xmlns:cc="http://xmlns.jcp.org/jsf/composite">
<cc:interface componentType="IvyComponent" />

<cc:implementation>
	<p:growl id="growl" showDetail="true" />
	<h:form id="systemDatabaseForm">
		<h:panelGrid columns="2" cellpadding="20" cellspacing="20">
			<p:fieldset id="databaseFieldSet" legend="Database">
				<h:panelGrid columns="2" cellpadding="1">
					<p:outputLabel for="databaseTypeDropdown" id="databaseTypeLabel"
						value="Database: " />
					<p:selectOneMenu id="databaseTypeDropdown"
						value="#{data.configData.product}" converter="ivy.ListItem" >
						<f:selectItems value="#{data.databaseProducts}" var="database"
							itemLabel="#{database.name}" itemValue="#{database}" />
						<p:ajax
							update="databaseDriverDropdown, portInput, databaseNameLabel"
							listener="#{logic.update}" />
					</p:selectOneMenu>

					<p:outputLabel for="databaseDriverDropdown"
						id="databaseDriverLabel" value="Driver: " />
					<p:selectOneMenu id="databaseDriverDropdown"
						value="#{data.configData.driver}" converter="ivy.ListItem">
						<f:selectItems value="#{data.databaseDrivers}" var="driver"
							itemLabel="#{driver.name}" itemValue="#{driver}" />
						<p:ajax event="change" update="portInput"
							listener="#{logic.setDefaultPort}" />
					</p:selectOneMenu>
					<p:outputLabel for="hostInput" id="hostLabel" value="Host:" />
					<p:inputText id="hostInput" value="#{data.configData.host}" styleClass="important-sysdb-input">
						<p:ajax event="change" update="@(.configChanged)"
							listener="#{logic.change}" />
					</p:inputText>
					<p:outputLabel for="portInput" id="portLabel" value="Port:" />
					<h:column>
						<p:inputText id="portInput" styleClass="port-input"
							value="#{data.configData.port}" disabled="#{data.defaultPort}" />
						<p:selectBooleanCheckbox id="defaultPortCheckbox"
							styleClass="port-checkbox" itemLabel="Default"
							value="#{data.defaultPort}">
							<p:ajax listener="#{logic.setDefaultPort}"
								update=":#{cc.clientId}:systemDatabaseForm:portInput" />
						</p:selectBooleanCheckbox>
					</h:column>
					<p:outputLabel for="databaseNameInput" id="databaseNameLabel"
						value="#{ivy.cms.co('/com.axonivy.engineconfig.ui/nameLabel/' += data.configData.product)}:" />
					<p:inputText id="databaseNameInput"
						value="#{data.configData.databaseName}" styleClass="important-sysdb-input">
						<p:ajax event="change" update="@(.configChanged)"
							listener="#{logic.change}" />
					</p:inputText>
					<p:outputLabel for="usernameInput" id="usernameLabel"
						value="Username:" />
					<p:inputText id="usernameInput" value="#{data.configData.username}" >
						<p:ajax event="change" update="@(.configChanged)"
							listener="#{logic.change}" />
					</p:inputText>
					<p:outputLabel for="passwordInput" id="passwordLabel"
						value="Password:" />
					<p:password id="passwordInput" value="#{data.configData.password}"
						redisplay="true" >
						<p:ajax event="change" update="@(.configChanged)"
							listener="#{logic.change}" />
					</p:password>
				</h:panelGrid>
			</p:fieldset>

			<p:fieldset id="connectionsStateFieldSet" legend="Connection State">
				<h:panelGrid columns="1" cellpadding="10">
					<p:commandButton id="checkConnectionButton"
						value="Check Connection" icon="fa fa-check"
						actionListener="#{logic.checkConnection}"
						update="@(.configChanged)" />
					<p:commandButton id="createDatabaseButton" value="Create Database"
						actionListener="#{logic.applyProperties}"
						oncomplete="PF('createDatabaseDialog').show()"
						icon="fa fa-database"
						update=":#{cc.clientId}:createDatabaseDialog" />
					<p:commandButton id="convertDbButton" value="Convert Database"
					    styleClass="configChanged"
						icon="fa fa-database" actionListener="#{logic.convertDb}"
						onclick="PF('convertDatabaseDialog').show()"
						disabled="#{!data.settings.connectionInfo.canConvert()}"
						update=":#{cc.clientId}:convertDatabaseDialog, @(.configChanged)" />
				</h:panelGrid>
			</p:fieldset>
			<p:commandButton id="saveConfigButton" icon="fa fa-save" ajax="true"
				value="Save Configuration" actionListener="#{logic.saveConfig}"
				update=":#{cc.clientId}:growl" />
		</h:panelGrid>
	</h:form>

	<p:dialog id="createDatabaseDialog" widgetVar="createDatabaseDialog"
		header="Create System Database" modal="true">
		<h:form id="createDatabaseForm">
			<h:outputText
				value="Enter the required parameters for your System Database configuration:" />
			<br />
			<br />
			<p:panelGrid>
				<ui:repeat var="parameter" value="#{data.requiredParameters}"
					varStatus="status">
					<p:row>
						<p:column>
							<p:outputLabel for="creationParam"
								value="#{ivy.cms.co('/com.axonivy.engineconfig.ui/creationParameters/' += parameter.name)}: " />
						</p:column>
						<p:column>
							<p:inputText
								value="#{data.configData.creationParameters[parameter.name]}"
								id="creationParam"
								disabled="#{parameter.name.equalsIgnoreCase('enginetype')}"
								required="true" />
						</p:column>
					</p:row>
				</ui:repeat>
			</p:panelGrid>
			<br />
			<p:commandButton value="Create Database"
				actionListener="#{logic.createDatabase}"
				update=":#{cc.clientId}:createDatabaseDialog, :#{cc.clientId}:creatingDatabaseForm:doUpdate"
				onsuccess="PF('creatingDatabaseDialog').show()"
				id="dialogCreateDbButton" />
		</h:form>
	</p:dialog>

	<p:dialog id="creatingDatabaseDialog"
		widgetVar="creatingDatabaseDialog" header="Creating System Database"
		dynamic="true" modal="true" onShow="PF('creatingOutputPoll').start()">

		<h:form id="creatingDatabaseForm">
			<p:poll autoStart="false" id="creatingOutputPoll"
				widgetVar="creatingOutputPoll"
				update="creatingDatabaseForm:doUpdate" interval="1"
				stop="#{!data.progressAction.running}" />
			<h:panelGrid id="doUpdate" columns="1" styleClass="full-width">

				<h:outputText value="Your database is being created..." />

				<p:progressBar id="progressbar" widgetVar="progressbar"
					value="#{data.progressAction.progress/(data.progressAction.maxProgress/100)}" />
				<br />
				<br />
				<p:outputPanel rendered="#{data.progressAction.error != null}"
					styleClass="alert alert-danger">
					<strong><h:outputText id="errorMessage"
							value="#{data.progressAction.error.message}" /></strong>
				</p:outputPanel>

				<p:outputPanel
					rendered="#{!data.progressAction.running and data.progressAction.error == null}"
					styleClass="alert alert-success">
					<strong><h:outputText id="finishMessage"
							value="Successfully Finished!" /></strong>
				</p:outputPanel>
				<br />
				<p:commandButton value="Save and connect" id="saveAndConnectButton"
					actionListener="#{logic.updateAndCheckConnection}"
					update="@(.configChanged), :#{cc.clientId}:creatingDatabaseDialog,
					 :#{cc.clientId}:systemDatabaseForm"
					disabled="#{data.progressAction.running}" />
			</h:panelGrid>
		</h:form>
	</p:dialog>

	<p:dialog id="convertDatabaseDialog" widgetVar="convertDatabaseDialog"
		header="Converting System Database" dynamic="true" modal="true"
		onShow="PF('convertingOutputPoll').start()">

		<h:form id="convertDatabaseForm">
			<p:poll autoStart="false" id="convertingOutputPoll"
				widgetVar="convertingOutputPoll"
				update="convertDatabaseForm:doUpdateConvertion" interval="1"
				stop="#{!data.progressAction.running}" />
			<h:panelGrid id="doUpdateConvertion" columns="1"
				styleClass="full-width">

				<h:outputText value="Your database is being converted..." />

				<p:progressBar id="progressbarConvertion"
					widgetVar="progressbarConvertion"
					value="#{data.progressAction.progress/(data.progressAction.maxProgress/100)}" />
				<br />
				<br />
				<p:outputPanel rendered="#{data.progressAction.error != null}"
					styleClass="alert alert-danger">
					<strong><h:outputText id="errorMessageConvertion"
							value="#{data.progressAction.error.message}" /></strong>
				</p:outputPanel>

				<p:outputPanel
					rendered="#{!data.progressAction.running and data.progressAction.error == null}"
					styleClass="alert alert-success">
					<strong><h:outputText id="finishMessageConvertion"
							value="Successfully Finished!" /></strong>
				</p:outputPanel>
			</h:panelGrid>
		</h:form>
	</p:dialog>
</cc:implementation>
</html>