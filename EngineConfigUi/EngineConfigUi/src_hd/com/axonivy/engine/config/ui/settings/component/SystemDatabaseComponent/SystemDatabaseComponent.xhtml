<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:f="http://xmlns.jcp.org/jsf/core"
	xmlns:h="http://xmlns.jcp.org/jsf/html"
	xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
	xmlns:ic="http://ivyteam.ch/jsf/component"
	xmlns:p="http://primefaces.org/ui"
	xmlns:pe="http://primefaces.org/ui/extensions"
	xmlns:pm="http://primefaces.org/mobile"
	xmlns:c="http://xmlns.jcp.org/jsp/jstl/core"
	xmlns:cc="http://xmlns.jcp.org/jsf/composite"
	xmlns:pt="http://xmlns.jcp.org/jsf/passthrough">
<cc:interface componentType="IvyComponent" />

<cc:implementation>
	<h:form id="systemDatabaseForm">
		<p:remoteCommand name="updateConnectionPanel" update="connection"
			async="true" delay="20" />
		<p:outputPanel id="connectionPanel" styleClass="connection-panel">
			<p:commandButton value="Check Connection" id="checkConnectionButton"
				icon="fa fa-check" styleClass="check-connection"
				actionListener="#{logic.applyProperties}"
				update="@(.configChanged), systemDatabaseForm, :#{cc.clientId}:createDatabaseDialog"
				onstart="PF('loadingDialog').show(); updateConnectionPanel();"
				oncomplete="PF('loadingDialog').hide();">
				<f:actionListener
					binding="#{helperBean.validateConfig(data.settings)}" />
			</p:commandButton>
			<p:outputPanel id="connection"
				styleClass="alert #{data.settings.connectionInfo.stateCssValue} connection-state configChanged">
				<h4>
					<i class="#{data.settings.connectionInfo.connectionIcon}" />
					<h:outputText value="#{data.settings.connectionInfo.stateTitle}"
						id="connectionState" styleClass="configChanged" />
				</h4>
				<p>
					<h:outputText value="#{data.settings.connectionInfo.stateMessage}"
						styleClass="configChanged" />
				</p>
			</p:outputPanel>
		</p:outputPanel>
		<div class="container-fluid">
			<div class="row">
				<div class="col-md-5">
					<h:panelGrid columns="2" cellpadding="1">
						<p:outputLabel for="databaseTypeDropdown" id="databaseTypeLabel"
							value="Database" />
						<p:selectOneMenu id="databaseTypeDropdown"
							value="#{data.configData.product}" converter="ivy.ListItem">
							<f:selectItems value="#{data.databaseProducts}" var="database"
								itemLabel="#{database.name}" itemValue="#{database}" />
							<p:ajax
								update="databaseDriverDropdown, portInput, databaseNameLabel, @(.configChanged)"
								listener="#{logic.updateProduct}" />
						</p:selectOneMenu>

						<p:outputLabel for="databaseDriverDropdown"
							id="databaseDriverLabel" value="Driver" />
						<p:selectOneMenu id="databaseDriverDropdown"
							value="#{data.configData.driver}" converter="ivy.ListItem">
							<f:selectItems value="#{data.databaseDrivers}" var="driver"
								itemLabel="#{driver.name}" itemValue="#{driver}" />
							<p:ajax update="portInput, @(.configChanged)"
								listener="#{logic.updateDriver}" />
						</p:selectOneMenu>
						<p:outputLabel for="hostInput" id="hostLabel" value="Host" />
						<p:inputText id="hostInput" value="#{data.configData.host}"
							styleClass="important-sysdb-input">
							<p:ajax event="keydown" update="@(.configChanged)"
								listener="#{logic.change}" />
						</p:inputText>
						<p:outputLabel for="portInput" id="portLabel" value="Port" />
						<h:column>
							<p:inputText id="portInput" styleClass="port-input"
								value="#{data.configData.port}" disabled="#{data.defaultPort}">
								<p:ajax event="keydown" update="@(.configChanged)"
									listener="#{logic.change}" />
							</p:inputText>
							<p:selectBooleanCheckbox id="defaultPortCheckbox"
								styleClass="port-checkbox" itemLabel="Default"
								value="#{data.defaultPort}">
								<p:ajax listener="#{logic.setDefaultPort}"
									update=":#{cc.clientId}:systemDatabaseForm:portInput, @(.configChanged)" />
							</p:selectBooleanCheckbox>
						</h:column>
						<p:outputLabel for="databaseNameInput" id="databaseNameLabel"
							value="#{ivy.cms.co('/com.axonivy.engineconfig.ui/nameLabel/' += data.configData.product)}" />
						<p:inputText id="databaseNameInput"
							value="#{data.configData.databaseName}"
							styleClass="important-sysdb-input">
							<p:ajax event="keydown" update="@(.configChanged)"
								listener="#{logic.change}" />
						</p:inputText>
						<p:outputLabel for="usernameInput" id="usernameLabel"
							value="Username" />
						<p:inputText id="usernameInput"
							value="#{data.configData.username}" autocomplete="off">
							<p:ajax event="keydown" update="@(.configChanged)"
								listener="#{logic.change}" />
						</p:inputText>
						<p:outputLabel for="passwordInput" id="passwordLabel"
							value="Password" />
						<p:password id="passwordInput" value="#{data.configData.password}"
							redisplay="true" autocomplete="new-password">
							<p:ajax event="keydown" update="@(.configChanged)"
								listener="#{logic.change}" />
						</p:password>
					</h:panelGrid>
					<br />
					<p:commandButton
						value="Additional Properties  
						#{helperBean.getPropertiesSize(data.configData.additionalProperties)}"
						id="additionalPropertiesButton" icon="fa fa-plus-circle"
						onclick="PF('additionalPropertiesDialog').show()" />
				</div>
			</div>
			<br />
			<div class="row">
				<p:commandButton id="createDatabaseButton" value="Create Database"
					actionListener="#{logic.applyProperties}"
					oncomplete="PF('createDatabaseDialog').show()"
					icon="fa fa-database" update=":#{cc.clientId}:createDatabaseDialog"
					styleClass="configChanged"
					disabled="#{data.settings.connectionInfo.connectionOK || data.settings.connectionInfo.canConvert()}" />
				<p:commandButton id="convertDbButton" value="Convert Database"
					styleClass="configChanged" icon="fa fa-database"
					oncomplete="PF('convertDatabaseDialog').show()"
					disabled="#{!data.settings.connectionInfo.canConvert()}"
					update=":#{cc.clientId}:convertDatabaseDialog, @(.configChanged)" />
				<p:commandButton id="systemDatabaseTabNextButton" value="Next"
					icon="fa fa-arrow-circle-right"
					styleClass="next-button , configChanged" update=":accordionPanel"
					actionListener="#{logic.applyProperties}"
					onstart="if(#{!data.connectionInfo.connectionOK})PF('loadingDialog').show();"
					oncomplete="if(PF('loadingDialog').isVisible()){PF('loadingDialog').hide()}; 
					if(#{data.connectionInfo.connectionOK})PF('accordionPanel').select(2);">
					<f:actionListener
						binding="#{helperBean.validateConfig(data.settings)}" />
				</p:commandButton>
			</div>
		</div>
	</h:form>

	<p:dialog id="createDatabaseDialog" widgetVar="createDatabaseDialog"
		header="Create System Database" modal="true" closeOnEscape="true">
		<h:form id="createDatabaseForm">
			<h:outputText
				value="Enter the required parameters for your System Database configuration:" />
			<br />
			<br />
			<p:panelGrid>
				<ui:repeat var="parameter" value="#{data.requiredParameters}"
					varStatus="status" id="uiRepeat">
					<p:row>
						<p:column>
							<p:outputLabel for="creationParam"
								value="#{ivy.cms.co('/com.axonivy.engineconfig.ui/creationParameters/' += parameter.name)}" />
						</p:column>
						<p:column>
							<p:inputText
								value="#{data.configData.creationParameters[parameter.name]}"
								id="creationParam"
								disabled="#{parameter.name.equalsIgnoreCase('enginetype')}"
								required="true" />
						</p:column>
					</p:row>
				</ui:repeat>
			</p:panelGrid>
			<br />
			<p:commandButton value="Create Database"
				actionListener="#{logic.createDatabase}"
				update="createDatabaseForm, :#{cc.clientId}:creatingDatabaseForm:doUpdate"
				oncomplete="if (args &amp;&amp; !args.validationFailed) {PF('createDatabaseDialog').hide(); PF('creatingDatabaseDialog').show();}"
				id="dialogCreateDbButton" />
			<p:defaultCommand target="dialogCreateDbButton" />
		</h:form>
	</p:dialog>

	<p:dialog id="creatingDatabaseDialog"
		widgetVar="creatingDatabaseDialog" header="Creating System Database"
		dynamic="true" modal="true" onShow="PF('creatingOutputPoll').start()"
		closeOnEscape="true">
		<h:form id="creatingDatabaseForm">
			<p:poll autoStart="false" id="creatingOutputPoll"
				widgetVar="creatingOutputPoll"
				update="creatingDatabaseForm:doUpdate" interval="1"
				stop="#{!data.progressAction.running}" />
			<h:panelGrid id="doUpdate" columns="1" styleClass="full-width">
				<p:focus context="doUpdate" />
				<h:outputText value="Your database is being created..." />
				<p:inputText type="hidden" />

				<p:progressBar id="progressbar" widgetVar="progressbar"
					value="#{data.progressAction.progress/(data.progressAction.maxProgress/100)}" />
				<br />
				<br />
				<p:outputPanel rendered="#{data.progressAction.error != null}"
					styleClass="alert alert-danger">
					<strong><h:outputText id="errorMessage"
							value="#{data.progressAction.error.message}" /></strong>
				</p:outputPanel>

				<p:outputPanel
					rendered="#{!data.progressAction.running and data.progressAction.error == null}"
					styleClass="alert alert-success">
					<strong><h:outputText id="finishMessage"
							value="Successfully Finished!" /></strong>
				</p:outputPanel>
				<br />
				<p:commandButton value="Save and connect" id="saveAndConnectButton"
					actionListener="#{logic.updateAndCheckConnection}"
					update="@(.configChanged), :#{cc.clientId}:creatingDatabaseDialog,
					 :#{cc.clientId}:systemDatabaseForm"
					rendered="#{!data.progressAction.running}"
					widgetVar="saveAndConnectionButton" />
			</h:panelGrid>
			<p:defaultCommand target="saveAndConnectButton" />
		</h:form>
	</p:dialog>

	<p:dialog id="convertDatabaseDialog" widgetVar="convertDatabaseDialog"
		header="Do you really want to convert?" dynamic="true" modal="true"
		closeOnEscape="true">
		<h:form id="convertDatabaseForm">
			<p:commandButton id="confirmConvertButton" value="Yes, convert"
				icon="fa fa-refresh" actionListener="#{logic.convertDb}"
				update="@(.configChanged), :#{cc.clientId}:convertingDatabaseForm:doUpdateConvertion"
				oncomplete="PF('convertDatabaseDialog').hide(); PF('convertingDatabaseDialog').show();" />
			<p:commandButton value="Cancel" icon="fa fa-times"
				oncomplete="PF('convertDatabaseDialog').hide();" />
			<p:defaultCommand target="confirmConvertButton" />
		</h:form>
	</p:dialog>

	<p:dialog id="convertingDatabaseDialog"
		widgetVar="convertingDatabaseDialog"
		header="Converting System Database" dynamic="true" modal="true"
		onShow="PF('convertingOutputPoll').start()" closeOnEscape="true">

		<h:form id="convertingDatabaseForm">
			<p:poll autoStart="false" id="convertingOutputPoll"
				widgetVar="convertingOutputPoll"
				update="convertingDatabaseForm:doUpdateConvertion" interval="1"
				stop="#{!data.progressAction.running}" />
			<h:panelGrid id="doUpdateConvertion" columns="1"
				styleClass="full-width">
				<p:focus context="doUpdateConvertion" />
				<h:outputText value="Your database is being converted..." />
				<p:inputText type="hidden" />

				<p:progressBar id="progressbarConvertion"
					widgetVar="progressbarConvertion"
					value="#{data.progressAction.progress/(data.progressAction.maxProgress/100)}" />
				<br />
				<br />
				<p:outputPanel rendered="#{data.progressAction.error != null}"
					styleClass="alert alert-danger">
					<strong><h:outputText id="errorMessageConvertion"
							value="#{data.progressAction.error.message}" /></strong>
				</p:outputPanel>

				<p:outputPanel
					rendered="#{!data.progressAction.running and data.progressAction.error == null}"
					styleClass="alert alert-success">
					<strong><h:outputText id="finishMessageConvertion"
							value="Successfully Finished!" /></strong>
				</p:outputPanel>
				<br />
				<p:commandButton value="Save and connect"
					id="saveAndConnectConvertionButton"
					actionListener="#{logic.saveAndCheckConnection}"
					update="@(.configChanged), :#{cc.clientId}:convertingDatabaseDialog,
					 :#{cc.clientId}:systemDatabaseForm"
					rendered="#{!data.progressAction.running}" />
			</h:panelGrid>
			<p:defaultCommand target="saveAndConnectConvertionButton" />
		</h:form>
	</p:dialog>

	<p:dialog widgetVar="additionalPropertiesDialog"
		id="additionalPropertiesDialog" closable="true" modal="true"
		width="50%" header="Additional Properties" closeOnEscape="true">
		<p:messages id="messages" />
		<h:form id="propertiesForm">
			<h:panelGrid columns="2" id="newPropertyPanelGrid">
				<p:outputLabel value="Key" for="newPropertyKey" />
				<p:inputText value="#{data.newPropertyKey}" id="newPropertyKey"
					required="true" styleClass="important-sysdb-input" />
				<p:outputLabel value="Value" for="newPropertyValue" />
				<p:inputText value="#{data.newPropertyValue}" id="newPropertyValue"
					required="true" styleClass="important-sysdb-input" />
				<br />
				<p:commandButton id="addAdditionalAttributeButton" value="Add"
					icon="fa fa-plus-circle" actionListener="#{logic.addNewProperty}"
					update=":#{cc.clientId}:listForm:propertiesTable, newPropertyPanelGrid, 
					:#{cc.clientId}:systemDatabaseForm:additionalPropertiesButton, @(.configChanged)" />
			</h:panelGrid>
			<p:defaultCommand target="addAdditionalAttributeButton" />
		</h:form>
		<br />
		<h:form id="listForm">
			<p:dataTable id="propertiesTable"
				value="#{data.configData.additionalProperties.entrySet().toArray()}"
				var="property" emptyMessage="No properties existing"
				styleClass="no-border">
				<p:column headerText="Key">
					<h:outputText value="#{property.key}" />
				</p:column>
				<p:column headerText="Value">
					<h:outputText value="#{property.value}" />
				</p:column>
				<p:column width="15" styleClass="action-column">
					<p:commandLink
						actionListener="#{logic.removeProperty(property.key)}"
						update=":#{cc.clientId}:listForm:propertiesTable, 
						:#{cc.clientId}:systemDatabaseForm:additionalPropertiesButton, @(.configChanged)"
						title="Remove property">
						<i class="fa fa-times" />
					</p:commandLink>
				</p:column>
			</p:dataTable>
		</h:form>
	</p:dialog>
</cc:implementation>
</html>