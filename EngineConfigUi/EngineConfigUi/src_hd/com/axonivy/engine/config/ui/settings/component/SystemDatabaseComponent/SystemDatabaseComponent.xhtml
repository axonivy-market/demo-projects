<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:f="http://xmlns.jcp.org/jsf/core"
	xmlns:h="http://xmlns.jcp.org/jsf/html"
	xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
	xmlns:ic="http://ivyteam.ch/jsf/component"
	xmlns:p="http://primefaces.org/ui"
	xmlns:pe="http://primefaces.org/ui/extensions"
	xmlns:pm="http://primefaces.org/mobile"
	xmlns:c="http://xmlns.jcp.org/jsp/jstl/core"
	xmlns:cc="http://xmlns.jcp.org/jsf/composite">
<cc:interface componentType="IvyComponent" />

<cc:implementation>
	<h:form id="systemDatabaseForm">
		<ic:com.axonivy.engine.config.ui.settings.component.ConnectionStateComponent
			id="connectionStateComponent" settings="#{data.settings}" />

		<div class="container-fluid">
			<div class="row">
				<div class="col-md-5">
					<h:panelGrid columns="2" cellpadding="1">
						<p:outputLabel for="databaseTypeDropdown" id="databaseTypeLabel"
							value="Database: " />
						<p:selectOneMenu id="databaseTypeDropdown"
							value="#{data.configData.product}" converter="ivy.ListItem">
							<f:selectItems value="#{data.databaseProducts}" var="database"
								itemLabel="#{database.name}" itemValue="#{database}" />
							<p:ajax
								update="databaseDriverDropdown, portInput, databaseNameLabel, @(.configChanged)"
								listener="#{logic.updateProduct}" />
						</p:selectOneMenu>

						<p:outputLabel for="databaseDriverDropdown"
							id="databaseDriverLabel" value="Driver: " />
						<p:selectOneMenu id="databaseDriverDropdown"
							value="#{data.configData.driver}" converter="ivy.ListItem">
							<f:selectItems value="#{data.databaseDrivers}" var="driver"
								itemLabel="#{driver.name}" itemValue="#{driver}" />
							<p:ajax update="portInput, @(.configChanged)"
								listener="#{logic.updateDriver}" />
						</p:selectOneMenu>
						<p:outputLabel for="hostInput" id="hostLabel" value="Host:" />
						<p:inputText id="hostInput" value="#{data.configData.host}"
							styleClass="important-sysdb-input">
							<p:ajax event="keyup" update="@(.configChanged)"
								listener="#{logic.change}" />
						</p:inputText>
						<p:outputLabel for="portInput" id="portLabel" value="Port:" />
						<h:column>
							<p:inputText id="portInput" styleClass="port-input"
								value="#{data.configData.port}" disabled="#{data.defaultPort}">
								<p:ajax event="keyup" update="@(.configChanged)"
									listener="#{logic.change}" />
							</p:inputText>
							<p:selectBooleanCheckbox id="defaultPortCheckbox"
								styleClass="port-checkbox" itemLabel="Default"
								value="#{data.defaultPort}">
								<p:ajax listener="#{logic.setDefaultPort}"
									update=":#{cc.clientId}:systemDatabaseForm:portInput, @(.configChanged)" />
							</p:selectBooleanCheckbox>
						</h:column>
						<p:outputLabel for="databaseNameInput" id="databaseNameLabel"
							value="#{ivy.cms.co('/com.axonivy.engineconfig.ui/nameLabel/' += data.configData.product)}:" />
						<p:inputText id="databaseNameInput"
							value="#{data.configData.databaseName}"
							styleClass="important-sysdb-input">
							<p:ajax event="keyup" update="@(.configChanged)"
								listener="#{logic.change}" />
						</p:inputText>
						<p:outputLabel for="usernameInput" id="usernameLabel"
							value="Username:" />
						<p:inputText id="usernameInput"
							value="#{data.configData.username}">
							<p:ajax event="keyup" update="@(.configChanged)"
								listener="#{logic.change}" />
						</p:inputText>
						<p:outputLabel for="passwordInput" id="passwordLabel"
							value="Password:" />
						<p:password id="passwordInput" value="#{data.configData.password}"
							redisplay="true">
							<p:ajax event="keyup" update="@(.configChanged)"
								listener="#{logic.change}" />
						</p:password>
					</h:panelGrid>
					<br />
					<p:commandButton
						value="Additional Properties 
						#{helperBean.getPropertiesSize(data.configData.additionalProperties)}"
						id="additionalPropertiesButton" icon="fa fa-plus-circle"
						onclick="PF('additionalPropertiesDialog').show()" />
				</div>
			</div>
			<br />
			<div class="row">
				<p:commandButton id="saveConfigButton" icon="fa fa-save"
					value="Save" actionListener="#{logic.saveConfig}" update="growl" />
				<p:commandButton id="createDatabaseButton" value="Create Database"
					actionListener="#{logic.applyProperties}"
					oncomplete="PF('createDatabaseDialog').show()"
					icon="fa fa-database" update=":#{cc.clientId}:createDatabaseDialog"
					styleClass="configChanged"
					disabled="#{data.settings.connectionInfo.connectionOK || data.settings.connectionInfo.canConvert()}" />
				<p:commandButton id="convertDbButton" value="Convert Database"
					styleClass="configChanged" icon="fa fa-database"
					oncomplete="PF('convertDatabaseDialog').show()"
					disabled="#{!data.settings.connectionInfo.canConvert()}"
					update=":#{cc.clientId}:convertDatabaseDialog, @(.configChanged)" />
				<p:commandButton id="systemDatabaseTabNextButton" value="Next"
					icon="fa fa-arrow-circle-right"
					styleClass="next-button , configChanged"
					update=":accordionPanel, #{cc.clientId}:nextStepDialog"
					actionListener="#{nextStepDialogBean.checkNextStepConnectionProblem(data.settings)}"
					oncomplete="if(#{data.settings.connectionInfo.connectionOK})PF('accordionPanel').select(2);
					 else PF('nextStepDialog').show();" />
			</div>
		</div>
		<p:defaultCommand target="saveConfigButton" />
	</h:form>

	<p:dialog id="nextStepDialog" widgetVar="nextStepDialog"
		header="#{nextStepDialogBean.title}" modal="true" closeOnEscape="true">
		<h:outputText value="#{nextStepDialogBean.message}" />
		<br />
		<br />
		<p:commandButton value="Next" icon="fa fa-arrow-circle-right"
			id="nextButtonCreate" actionListener="#{logic.applyProperties}"
			oncomplete="PF('nextStepDialog').hide(); PF('createDatabaseDialog').show();"
			update=":#{cc.clientId}:createDatabaseDialog"
			rendered="#{nextStepDialogBean.step eq 'createDb'}" />
		<p:commandButton value="Next" icon="fa fa-arrow-circle-right"
			id="nextButtonConvert"
			oncomplete="PF('nextStepDialog').hide(); PF('convertDatabaseDialog').show();"
			rendered="#{nextStepDialogBean.step eq 'convertDb'}" />
		<p:commandButton value="Next" icon="fa fa-arrow-circle-right"
			id="nextButtonWrongConfig" onclick="PF('nextStepDialog').hide();"
			rendered="#{nextStepDialogBean.step eq 'wrongLogin' or 'noPassword' or 'wrongPassword' or 'wrongHost'}" />
		<p:commandButton value="Next" icon="fa fa-arrow-circle-right"
			id="nextButtonConnectionOk"
			oncomplete="PF('nextStepDialog').hide(); PF('accordionPanel').select(2);"
			rendered="#{nextStepDialogBean.step eq 'connectionOk'}" />
	</p:dialog>

	<p:dialog id="createDatabaseDialog" widgetVar="createDatabaseDialog"
		header="Create System Database" modal="true" closeOnEscape="true">
		<h:form id="createDatabaseForm">
			<h:outputText
				value="Enter the required parameters for your System Database configuration:" />
			<br />
			<br />
			<p:panelGrid>
				<ui:repeat var="parameter" value="#{data.requiredParameters}"
					varStatus="status">
					<p:row>
						<p:column>
							<p:outputLabel for="creationParam"
								value="#{ivy.cms.co('/com.axonivy.engineconfig.ui/creationParameters/' += parameter.name)}: " />
						</p:column>
						<p:column>
							<p:inputText
								value="#{data.configData.creationParameters[parameter.name]}"
								id="creationParam"
								disabled="#{parameter.name.equalsIgnoreCase('enginetype')}"
								required="true" />
						</p:column>
					</p:row>
				</ui:repeat>
			</p:panelGrid>
			<br />
			<p:commandButton value="Create Database"
				actionListener="#{logic.createDatabase}"
				update=":#{cc.clientId}:createDatabaseDialog, :#{cc.clientId}:creatingDatabaseForm:doUpdate"
				oncomplete="if (args &amp;&amp; !args.validationFailed) PF('creatingDatabaseDialog').show()"
				id="dialogCreateDbButton" />
		</h:form>
	</p:dialog>

	<p:dialog id="creatingDatabaseDialog"
		widgetVar="creatingDatabaseDialog" header="Creating System Database"
		dynamic="true" modal="true" onShow="PF('creatingOutputPoll').start()"
		closeOnEscape="true">

		<h:form id="creatingDatabaseForm">
			<p:poll autoStart="false" id="creatingOutputPoll"
				widgetVar="creatingOutputPoll"
				update="creatingDatabaseForm:doUpdate" interval="1"
				stop="#{!data.progressAction.running}" />
			<h:panelGrid id="doUpdate" columns="1" styleClass="full-width">

				<h:outputText value="Your database is being created..." />

				<p:progressBar id="progressbar" widgetVar="progressbar"
					value="#{data.progressAction.progress/(data.progressAction.maxProgress/100)}" />
				<br />
				<br />
				<p:outputPanel rendered="#{data.progressAction.error != null}"
					styleClass="alert alert-danger">
					<strong><h:outputText id="errorMessage"
							value="#{data.progressAction.error.message}" /></strong>
				</p:outputPanel>

				<p:outputPanel
					rendered="#{!data.progressAction.running and data.progressAction.error == null}"
					styleClass="alert alert-success">
					<strong><h:outputText id="finishMessage"
							value="Successfully Finished!" /></strong>
				</p:outputPanel>
				<br />
				<p:commandButton value="Save and connect" id="saveAndConnectButton"
					actionListener="#{logic.updateAndCheckConnection}"
					update="@(.configChanged), :#{cc.clientId}:creatingDatabaseDialog,
					 :#{cc.clientId}:systemDatabaseForm"
					disabled="#{data.progressAction.running}" />
			</h:panelGrid>
		</h:form>
	</p:dialog>

	<p:dialog id="convertDatabaseDialog" widgetVar="convertDatabaseDialog"
		header="Do you really want to convert?" dynamic="true" modal="true"
		closeOnEscape="true">
		<h:form id="convertDatabaseForm">
			<p:commandButton value="Yes, convert" icon="fa fa-refresh"
				actionListener="#{logic.convertDb}"
				update="@(.configChanged), :#{cc.clientId}:convertingDatabaseForm:doUpdateConvertion"
				oncomplete="PF('convertDatabaseDialog').hide(); PF('convertingDatabaseDialog').show();" />
			<p:commandButton value="Cancel" icon="fa fa-times"
				oncomplete="PF('convertDatabaseDialog').hide();" />
		</h:form>
	</p:dialog>

	<p:dialog id="convertingDatabaseDialog"
		widgetVar="convertingDatabaseDialog"
		header="Converting System Database" dynamic="true" modal="true"
		onShow="PF('convertingOutputPoll').start()" closeOnEscape="true">

		<h:form id="convertingDatabaseForm">
			<p:poll autoStart="false" id="convertingOutputPoll"
				widgetVar="convertingOutputPoll"
				update="convertingDatabaseForm:doUpdateConvertion" interval="1"
				stop="#{!data.progressAction.running}" />
			<h:panelGrid id="doUpdateConvertion" columns="1"
				styleClass="full-width">

				<h:outputText value="Your database is being converted..." />

				<p:progressBar id="progressbarConvertion"
					widgetVar="progressbarConvertion"
					value="#{data.progressAction.progress/(data.progressAction.maxProgress/100)}" />
				<br />
				<br />
				<p:outputPanel rendered="#{data.progressAction.error != null}"
					styleClass="alert alert-danger">
					<strong><h:outputText id="errorMessageConvertion"
							value="#{data.progressAction.error.message}" /></strong>
				</p:outputPanel>

				<p:outputPanel
					rendered="#{!data.progressAction.running and data.progressAction.error == null}"
					styleClass="alert alert-success">
					<strong><h:outputText id="finishMessageConvertion"
							value="Successfully Finished!" /></strong>
				</p:outputPanel>
			</h:panelGrid>
		</h:form>
	</p:dialog>

	<p:dialog widgetVar="additionalPropertiesDialog"
		id="additionalPropertiesDialog" closable="true" modal="true"
		width="50%" header="Additional Properties" closeOnEscape="true">
		<p:messages id="messages" />
		<h:form id="propertiesForm">
			<h:panelGrid columns="2" id="newPropertyPanelGrid">
				<p:outputLabel value="Key: " for="newPropertyKey" />
				<p:inputText value="#{data.newPropertyKey}" id="newPropertyKey"
					required="true" styleClass="important-sysdb-input" />
				<p:outputLabel value="Value: " for="newPropertyValue" />
				<p:inputText value="#{data.newPropertyValue}" id="newPropertyValue"
					required="true" styleClass="important-sysdb-input" />
				<br />
				<p:commandButton value="Add" icon="fa fa-plus-circle"
					actionListener="#{logic.addNewProperty}"
					update=":#{cc.clientId}:listForm:propertiesTable, newPropertyPanelGrid, 
					:#{cc.clientId}:systemDatabaseForm:additionalPropertiesButton, @(.configChanged)" />
			</h:panelGrid>
		</h:form>
		<br />
		<h:form id="listForm">
			<p:dataTable id="propertiesTable"
				value="#{data.configData.additionalProperties.entrySet().toArray()}"
				var="property" emptyMessage="No properties existing"
				styleClass="no-border">
				<p:column headerText="Key">
					<h:outputText value="#{property.key}" />
				</p:column>
				<p:column headerText="Value">
					<h:outputText value="#{property.value}" />
				</p:column>
				<p:column width="15" styleClass="action-column">
					<p:commandLink
						actionListener="#{logic.removeProperty(property.key)}"
						update=":#{cc.clientId}:listForm:propertiesTable, 
						:#{cc.clientId}:systemDatabaseForm:additionalPropertiesButton, @(.configChanged)"
						title="Remove property">
						<i class="fa fa-times" />
					</p:commandLink>
				</p:column>
			</p:dataTable>
		</h:form>
	</p:dialog>
</cc:implementation>
</html>